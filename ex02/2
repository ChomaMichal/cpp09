#include "PmergeMe.hpp"
#include <algorithm>
#include <cmath>
#include <vector>

std::vector<int> jac_sequence_n(int n) {
  std::vector<int> rt;
  if (n <= 0)
    return rt;

  rt.push_back(0); // J(0)
  if (n == 1)
    return rt;

  rt.push_back(1); // J(1)

  for (int i = 2; i < n; ++i) {
    rt.push_back(rt[i - 1] + 2 * rt[i - 2]);
  }

  return rt;
}

ulong nex_jac_number(ulong &curent, ulong &prev) {
  if (curent == 0) {
    curent = 1;
    prev = 0;
    return 1;
  }
  if (curent == 1) {
    curent = 3;
    prev = 1;
    return 3;
  }
  ulong pair = curent;
  curent = curent + 2 * prev;
  prev = pair;
  return (curent);
}

std::vector<r_pair *> create_pair(std::vector<int> &vec) {
  std::vector<int>::iterator iter = vec.begin();
  std::vector<r_pair *> rt;
  while (true) {
    std::vector<int>::iterator el1 = iter;
    iter++;
    if (iter == vec.end()) {
      r_pair *single = new r_pair();
      single->bigger = (*el1);
      single->rest_bigger = NULL;
      single->rest_smaller = NULL;
      single->alone = true;
      rt.push_back(single);
      break;
    }
    std::vector<int>::iterator el2 = iter;
    if ((*el1) > (*el2)) {
      r_pair *pair = new r_pair();
      pair->bigger = (*el1);
      pair->rest_bigger = NULL;
      pair->smaller = (*el2);
      pair->rest_smaller = NULL;
      pair->alone = false;
      rt.push_back(pair);
    } else {
      r_pair *pair = new r_pair();
      pair->bigger = (*el2);
      pair->rest_bigger = NULL;
      pair->smaller = (*el1);
      pair->rest_smaller = NULL;
      pair->alone = false;
      rt.push_back(pair);
    }
    iter++;
    if (iter == vec.end())
      break;
  }
  // for (int i = 0; i != rt.size(); i++) {
  //   print_r_pair(rt[i]);
  //   std::cout << " in first iteration\n";
  // }
  return (rt);
}

std::vector<r_pair *> create_pair(std::vector<r_pair *> &pairs) {
  std::vector<r_pair *>::iterator iter = pairs.begin();
  std::vector<r_pair *> rt;
  while (true) {
    std::vector<r_pair *>::iterator el1 = iter;
    iter++;
    if (iter == pairs.end()) {
      r_pair *single = new r_pair();
      single->bigger = (*el1)->bigger;
      single->rest_bigger = &*(*el1);
      single->alone = true;
      rt.push_back(single);
      break;
    }
    std::vector<r_pair *>::iterator el2 = iter;
    if ((*el1)->bigger > (*el2)->bigger) {
      r_pair *pair = new r_pair();
      pair->bigger = (*el1)->bigger;
      pair->rest_bigger = &*(*el1);
      pair->smaller = (*el2)->smaller;
      pair->rest_smaller = &*(*el2);
      pair->alone = false;
      rt.push_back(pair);
    } else {
      r_pair *pair = new r_pair();
      pair->bigger = (*el2)->bigger;
      pair->rest_bigger = &*(*el2);
      pair->smaller = (*el1)->smaller;
      pair->rest_smaller = &*(*el1);
      pair->alone = false;
      rt.push_back(pair);
    }
    iter++;
    if (iter == pairs.end())
      break;
  }
  return (rt);
}

bool r_pair_comp(r_pair *v1, r_pair *v2) {
#ifdef DEBUG
  static int i = 0;
  i++;
  std::cerr << i << " comperesons were done\n";
#endif // DEBUG
  return (v1->bigger > v2->bigger);
}

std::vector<r_pair *> insertions(std::vector<r_pair *> array,
                                 r_pair *left_out) {
  ulong current = 0;
  ulong prev = 0;
  std::vector<r_pair *> rt;
  std::vector<r_pair *>::iterator iter = array.begin();
  while (true) {
    ulong in_pos = nex_jac_number(current, prev);
    if (in_pos == 1) {
      rt.push_back((*iter)->rest_smaller);
      rt.push_back((*iter)->rest_bigger);
      iter++;
      continue;
    }
    if (in_pos > array.size())
      in_pos = array.size() - 1;
    if (prev >= array.size())
      break;
    for (int i = 0; in_pos > prev + i; i++) {
      rt.push_back((*iter)->rest_bigger);
      iter++;
    }

    std::vector<r_pair *>::iterator in_iter = iter;
    for (int i = 0; in_pos > prev + 1; i++) {
      std::vector<r_pair *>::iterator pos = std::lower_bound(
          rt.begin(), std::find(rt.begin(), rt.end(), (*in_iter)->rest_bigger),
          (*in_iter)->rest_smaller, r_pair_comp);
      rt.insert(pos, (*in_iter)->rest_smaller);
      in_iter--;
    }
  }
  if (left_out != NULL) {
    std::vector<r_pair *>::iterator pos = std::lower_bound(
        rt.begin(), rt.end(), left_out->rest_bigger, r_pair_comp);
    rt.insert(pos, left_out->rest_bigger);
    delete left_out;
  }
  for (std::vector<r_pair *>::iterator i = array.begin(); i != array.end();
       i++) {
    delete *i;
  }
  return (rt);
}

void print_r_pair(r_pair *pair) {
  if (pair == NULL)
    return;
  if (pair->alone == true) {
    if (pair->rest_bigger == NULL) {
      std::cout << "[" << pair->bigger << "]";
      return;
    }
    print_r_pair(pair->rest_bigger);
    return;
  }

  if (pair->rest_bigger == NULL) {
    std::cout << "[" << pair->bigger << ", " << pair->smaller << "]";
    return;
  }
  std::cout << "[";
  print_r_pair(pair->rest_bigger);
  std::cout << ", ";
  print_r_pair(pair->rest_smaller);
  std::cout << "]";
}

bool int_addr_cmp(int *i, int *j) { return (*i < *j); }

std::vector<int> reconstruct_vec(std::vector<r_pair *> array) {
  ulong current = 0;
  ulong prev = 0;
  std::vector<int *> tmp;
  std::vector<r_pair *>::iterator iter = array.begin();
  while (true) {
    ulong in_pos = nex_jac_number(current, prev);
    if (in_pos == 1) {
      tmp.push_back(&(*iter)->smaller);
      tmp.push_back(&(*iter)->bigger);
      iter++;
      continue;
    }
    if (in_pos > array.size())
      in_pos = array.size() - 1;
    if (prev >= array.size()) {
      std::cout << array.size() << " array size" << std::endl;
      std::cout << prev << " prev" << std::endl;
      std::cout << in_pos << " in_pos" << std::endl;
      break;
    }
    for (int i = 0; in_pos > prev + i; i++) {
      tmp.push_back(&(*iter)->bigger);
      iter++;
    }

    std::vector<r_pair *>::iterator in_iter = iter;
    for (int i = 0; in_pos > prev + 1; i++) {
      std::vector<int *>::iterator pos = std::lower_bound(
          tmp.begin(), std::find(tmp.begin(), tmp.end(), &(*in_iter)->bigger),
          &(*in_iter)->smaller, int_addr_cmp);
      tmp.insert(pos, &(*in_iter)->smaller);
      in_iter--;
    }
  }
  std::vector<int> rt;
  for (std::vector<int *>::iterator i = tmp.begin(); i != tmp.end(); i++) {
    rt.push_back(**i);
  }
  return (rt);
}

/*
std::vector<r_pair *> last_insercion(std::vector<r_pair *> array,
                                     r_pair *left_out) {
  ulong current = 0;
  ulong prev = 0;
  std::vector<r_pair *> rt;
  std::vector<r_pair *>::iterator iter = array.begin();
  while (true) {
    ulong in_pos = nex_jac_number(current, prev);
    if (in_pos == 1) {
      rt.push_back((*iter)->rest_smaller);
      rt.push_back((*iter)->rest_bigger);
      iter++;
      continue;
    }
    if (in_pos > array.size())
      in_pos = array.size() - 1;
    if (prev > array.size())
      return rt;
    while (in_pos > prev) {

      for (int i = 0; in_pos > prev + i; i++) {
        rt.push_back((*iter)->rest_bigger);
        iter++;
      }

      std::vector<r_pair *>::iterator in_iter = iter;
      for (int i = 0; in_pos > prev + 1; i++) {
        std::vector<r_pair *>::iterator pos = std::lower_bound(
            rt.begin(),
            std::find(rt.begin(), rt.end(), (*in_iter)->rest_bigger),
            (*in_iter)->rest_smaller, r_pair_comp);
        rt.insert(pos, (*in_iter)->rest_smaller);
        in_iter--;
      }
    }
  }
  if (left_out != NULL) {
    std::vector<r_pair *>::iterator pos = std::lower_bound(
        rt.begin(), rt.end(), left_out->rest_bigger, r_pair_comp);
    rt.insert(pos, left_out->rest_bigger);
    delete left_out;
  }
  for (std::vector<r_pair *>::iterator i = array.begin(); i != array.end();
       i++) {
    delete *i;
  }
}
*/

std::vector<int> vec_pmerge_me(std::vector<int> &vec) {

  // auto hehe = jac_sequence_n(9);
  // print_c(hehe);
  // return;
  auto pair = create_pair(vec);
  std::vector<r_pair *> left_out;
  std::cout << (pair.back())->alone << " :alone\n";
  if (pair.back()->alone == true) {
    left_out.push_back(pair.back());
    pair.pop_back();
  } else {
    left_out.push_back(NULL);
  }
  std::cout << std::endl;
  while (pair.size() != 1) {
    pair = create_pair(pair);
    std::cout << pair.back()->alone << " :alone\n";
    if (pair.back()->alone == true) {
      left_out.push_back(pair.back());
      pair.pop_back();
    } else {
      left_out.push_back(NULL);
    }
  }
  print_r_pair(pair[0]);
  std::cout << " pair before insertion" << std::endl;
  while (pair[0]->rest_smaller != NULL) {
    pair = insertions(pair, left_out.back());
    for (int i = 0; i < pair.size(); i++) {
      if (pair[i] != NULL) {
        std::cout << "\n" << i << " = i\n";
        print_r_pair(pair[i]);
        std::cout << "\n";
      } else {
        std::cout << "[NULL]\n";
      }
    }
    left_out.pop_back();
  }

  std::vector<int> rt = reconstruct_vec(pair);
  std::cout << rt.size() << "rt size " << std::endl;
  print_c(rt);
  return (rt);
  // std::cout << left_out.size() << std::endl;
  // for (int i =  0; i < left_out.size(); i++) {
  //   if (left_out[i]  != NULL) {
  //     print_r_pair(left_out[i]);
  //     std::cout << "\n";
  //   } else {
  //     std::cout << "[NULL]\n";
  //   }
  // }
  // auto hehe = jac_sequence_n(9);
  // print_c(hehe);
  // std::cout << std::endl;
}
